#!/usr/bin/env bash

set -eu

# wait-for-builds-and-do filter-flags do-args...
set -o pipefail
while ! list-unfinished-builds $CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME $1 \
        --before-build $CIRCLE_BUILD_NUM | xargs assert-no-builds; do
    echo "Retrying in 5 seconds..."
    sleep 5
done
echo "Acquired \"lock\""
"${@:2}"
