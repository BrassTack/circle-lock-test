assert-no-builds() {
    if [ $# -eq 0 ]; then
        return 0
    else
        echo "Waiting on builds:"
        for build in $@; do
            echo "  $build"
        done
        return 1
    fi
}

export -f assert-no-builds

# wait-and-do filter-flags do-args...
wait-and-do() {
    set -o pipefail
    while ! list-unfinished-builds $CIRCLE_PROJECT_USERNAME/$CIRCLE_PROJECT_REPONAME $1 \
            --before-build $CIRCLE_BUILD_NUM | xargs assert-no-builds; do
        echo "Retrying in 5 seconds..."
        sleep 5
    done
    echo "Acquired \"lock\""
    "${@:2}"
}
